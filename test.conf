server {
    listen 80;
    server_name 46.202.164.64;

    # Tidak ada redirect di sini, bisa melayani HTTP biasa untuk domain lain
    location / {
        #proxy_pass http://127.0.0.1:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
[root@srv659651 conf.d]# cat kios.conf
proxy_cache_path /var/cache/nginx/kiosk levels=1:2 keys_zone=kiosk_cache:10m max_size=4g inactive=30m use_temp_path=off;

server {
    listen 80;
    server_name kiosk.penerbitan-dpr.id;

    # Arahkan semua permintaan HTTP ke HTTPS
    return 301 https://kiosk.penerbitan-dpr.id;
}

server {
    listen 443 ssl http2;
    server_name kiosk.penerbitan-dpr.id;

    # Konfigurasi SSL
    ssl_certificate /etc/letsencrypt/live/kiosk.penerbitan-dpr.id/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/kiosk.penerbitan-dpr.id/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    ssl_session_cache shared:SSL:10m;

    # Tambahkan header Content-Security-Policy
    add_header Content-Security-Policy "frame-ancestors 'self' https://emedia.dpr.go.id";

    # Lokasi untuk acme-challenge (untuk verifikasi Let's Encrypt)
    #location /.well-known/acme-challenge/ {
    #    root /var/www/html;  # Arahkan ke direktori statis untuk verifikasi
    #}
    
#    client_max_body_size 500M;
    # ðŸš€ Ultra Fast Uploads
    client_max_body_size 5G;   # Allows uploading very large files
    client_body_buffer_size 512k;
    client_body_timeout 300s;
    client_header_timeout 300s;
    keepalive_timeout 75s;

    # Konfigurasi untuk permintaan lainnya
#    location / {
#        proxy_pass http://127.0.0.1:8000;
#        proxy_set_header Host $host;
#        proxy_set_header X-Real-IP $remote_addr;
#        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#        proxy_set_header X-Forwarded-Proto $scheme;

        # Bypass cache jika Set-Cookie ada
#        proxy_cache_bypass $http_cookie;

        # Caching dan pengaturan terkait
        #proxy_cache kiosk_cache;
#        proxy_cache_valid 200 302 10m;
#        proxy_cache_valid 404 1m;
#        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

        # Mengabaikan header yang memengaruhi cache
#        proxy_ignore_headers Cache-Control Expires Set-Cookie;

        # Pengaturan Cache-Control untuk memastikan cache divalidasi ulang
#        proxy_set_header Cache-Control "no-cache, must-revalidate";

        # Menambahkan header untuk status cache
#        add_header X-Cache-Status $upstream_cache_status always;
#    }

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cache Bypass for Dynamic Content
        proxy_cache_bypass $http_cookie;

        # Caching Configuration
        proxy_cache kiosk_cache;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

        # Ignore Cache Headers
        proxy_ignore_headers Cache-Control Expires Set-Cookie;

        # Ensure Cache Validation
        proxy_set_header Cache-Control "no-cache, must-revalidate";

        # Cache Status Header
        add_header X-Cache-Status $upstream_cache_status always;
    }

    # Livewire Fix: Disable Cache and Support WebSockets
    location /livewire/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Keep Connection Open for WebSockets
        proxy_read_timeout 300;
        proxy_connect_timeout 300;

        # Disable Caching
        proxy_cache off;
        proxy_buffering off;
    }

    #location ~ ^/back-office/(displays|layouts|media|media-sliders|playlists|media-videos|media-htmls)$ {
    #    proxy_pass http://127.0.0.1:8000;
    #    proxy_cache_key "$uri?$args$http_user_agent";
    #    proxy_set_header Host $host;
    #    proxy_set_header X-Real-IP $remote_addr;
    #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #    proxy_set_header X-Forwarded-Proto $scheme;

        # Konfigurasi caching
        #proxy_http_version 1.1;
        #proxy_cache kiosk_cache;                                                               #Menggunakan zona cache yang sudah didefinisikan
        #proxy_cache_revalidate on;                                                             #Revalidasi cache saat permintaan baru
        #proxy_cache_background_update on;                                                      #Perbarui cache di latar belakang
        #proxy_cache_lock on;                                                                   #Kunci agar hanya satu proses yang memperbarui cache pada saat bersamaan
        #proxy_cache_valid 200 302 10m;                                                         #Validitas cache untuk status 200 dan 302 selama 10 menit
        #proxy_cache_valid 304 1m;                                                              # Untuk respons 304, yang menandakan konten tidak berubah
        #proxy_cache_valid 404 1m;                                                              #Validitas cache untuk status 404 selama 1 menit
        #proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;      #Gunakan cache yang lama jika terjadi error pada upstream
        #proxy_set_header Cache-Control "no-cache, must-revalidate";                            #Untuk memastikan bahwa cache harus diverifikasi ulang sebelum digunakan
        #proxy_ignore_headers Cache-Control Expires Set-Cookie;                                 #Menginstruksikan NGINX untuk mengabaikan header Cache-Control, Expires, dan Set-Cookie dari respons upstream ketika menentukan apakah suatu respons dapat dicache

        # Menambahkan header untuk status cache dan pengaturan cache
        #add_header Cache-Control "public, max-age=3600" always;
        #add_header Vary "User-Agent" always;                                                   # Cache bisa bervariasi tergantung pada User-Agent
        #add_header X-Cache-Status $upstream_cache_status always;
    #}

    #location /display {
    #    proxy_pass http://127.0.0.1:8000;
    #    proxy_cache_key "$uri?$args$http_user_agent";
    #    proxy_set_header Host $host;
    #    proxy_set_header X-Real-IP $remote_addr;
    #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #    proxy_set_header X-Forwarded-Proto $scheme;

        # Konfigurasi caching
    #    proxy_http_version 1.1;
    #    proxy_cache kiosk_cache;                                                                #Menggunakan zona cache yang sudah didefinisikan
    #    proxy_cache_revalidate on;                                                              #Revalidasi cache saat permintaan baru
    #    proxy_cache_background_update on;                                                       #Perbarui cache di latar belakang
    #    proxy_cache_lock on;                                                                    #Kunci agar hanya satu proses yang memperbarui cache pada saat bersamaan
    #    proxy_cache_valid 200 302 10m;                                                          #Validitas cache untuk status 200 dan 302 selama 10 menit
    #    proxy_cache_valid 304 1m;                                                               # Untuk respons 304, yang menandakan konten tidak berubah
    #    proxy_cache_valid 404 1m;                                                               #Validitas cache untuk status 404 selama 1 menit
    #    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;       #Gunakan cache yang lama jika terjadi error pada upstream
    #    proxy_set_header Cache-Control "no-cache, must-revalidate";                             #Untuk memastikan bahwa cache harus diverifikasi ulang sebelum digunakan
    #    proxy_ignore_headers Cache-Control Expires Set-Cookie;                                  #Menginstruksikan NGINX untuk mengabaikan header Cache-Control, Expires, dan Set-Cookie dari respons >

        # Menambahkan header untuk status cache dan pengaturan cache
    #    add_header Cache-Control "public, max-age=3600" always;
    #    add_header Vary "User-Agent" always;                                                    # Cache bisa bervariasi tergantung pada User-Agent
    #     add_header X-Cache-Status $upstream_cache_status always;
    #}

    location /storage {
        proxy_pass http://127.0.0.1:8000;
        proxy_cache_key "$uri?$args$http_user_agent";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Konfigurasi caching
        proxy_http_version 1.1;
        proxy_cache kiosk_cache;                                                                #Menggunakan zona cache yang sudah didefinisikan
        proxy_cache_revalidate on;                                                              #Revalidasi cache saat permintaan baru
        proxy_cache_background_update on;                                                       #Perbarui cache di latar belakang
        proxy_cache_lock on;                                                                    #Kunci agar hanya satu proses yang memperbarui cache pada saat bersamaan
        proxy_cache_valid 200 302 10m;                                                          #Validitas cache untuk status 200 dan 302 selama 10 menit
        proxy_cache_valid 304 1m;                                                               # Untuk respons 304, yang menandakan konten tidak berubah
        proxy_cache_valid 404 1m;                                                               #Validitas cache untuk status 404 selama 1 menit
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;       #Gunakan cache yang lama jika terjadi error pada upstream
        proxy_set_header Cache-Control "no-cache, must-revalidate";                             #Untuk memastikan bahwa cache harus diverifikasi ulang sebelum digunakan
        proxy_ignore_headers Cache-Control Expires Set-Cookie;                                  #Menginstruksikan NGINX untuk mengabaikan header Cache-Control, Expires, dan Set-Cookie dari respons >
        # Menambahkan header untuk status cache dan pengaturan cache
        add_header Cache-Control "public, max-age=3600" always;
        add_header Vary "User-Agent" always;                                                    # Cache bisa bervariasi tergantung pada User-Agent
        add_header X-Cache-Status $upstream_cache_status always;
    }

    #location /livewire/ {
    #    proxy_pass http://127.0.0.1:8000;
    #    proxy_set_header Host $host;
    #    proxy_set_header X-Real-IP $remote_addr;
    #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #    proxy_set_header X-Forwarded-Proto $scheme;
    #    proxy_read_timeout 300;
    #     proxy_cache off;
    #}

    location /generate-pdf {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }

    location /view-pdf {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }
    location /custom-layout {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }
    location /data-layout {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }
    location /node_modules/gridstack/dist/gridstack.min.css {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }
    location /demo.css {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }
    location /node_modules/gridstack/dist/gridstack-all.js {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }
    location /data_table {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }
    location /yaudah {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }
    location /status_service {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /graph_playlist {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /status_device {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /emedia {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /send_refresh_device {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /process-video {
        proxy_pass http://127.0.0.1:3337;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /play-video {
        proxy_pass http://127.0.0.1:3337;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /ws {
        proxy_pass http://127.0.0.1:3335/ws;  # WebSocket URL with non-SSL (ws://)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Handle WebSocket connection upgrade headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
    }
    location /ws_status_device {
        proxy_pass http://127.0.0.1:3336/ws_status_device;  # WebSocket URL with non-SSL (ws://)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Handle WebSocket connection upgrade headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
    }
    location /convert {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Allow large body sizes (adjust as needed)
        client_max_body_size 99999M;

        # Timeout settings for slow processes
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;

        # Disable buffering for better real-time responses
        proxy_request_buffering off;
        proxy_buffering off;
    }
    location /hls/ {
        proxy_pass http://127.0.0.1:3333;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Streaming requires appropriate headers
        add_header Cache-Control no-cache;

        # Ensure byte-range support for HLS
        proxy_force_ranges on;

        # Timeout settings
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;

        # Disable buffering for better streaming
        proxy_request_buffering off;
        proxy_buffering off;
    }

    location ~ \.php$ {
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
        fastcgi_read_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_connect_timeout 60s;
    }

    location /protected/images/ {
        # Internal access only (for X-Accel-Redirect)
        internal;
        
        # Define the root directory where the files are stored
        root /root/kiosk/cosmic-media-streaming-dpr/storage/app/public/;
    }

    # Penanganan error
    error_page 404 /404.html;
    location = /404.html {
        root /var/www/kiosk;
    }

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_static on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_http_version 1.0;
    gzip_proxied any;
    gzip_buffers 16 8k;
    gzip_disable "MSIE [1-6].(?!.*SV1)";
    gzip_vary on;
}